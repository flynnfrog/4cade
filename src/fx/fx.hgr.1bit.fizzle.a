;license:MIT
;(c) 2017-2020 by qkumba/4am

!cpu 6502
!to "build/FX/BIT.FIZZLE",plain
*=$6000

rnd1=$fe
rnd2=$ff

         ;init RNG

         ldy   #1
         sty   rnd1
         dey
         sty   rnd2

         ;iterate

         ldx   #0
@loop
         lda   rnd1
@loop2
         eor   #$ff
         sta   $26
         sta   $3c
         lsr   rnd2
         ror   rnd1
         bcc   +

         ;feedback polynomial forms #$8016 for period of 65535

         lda   rnd1
         eor   #$16
         sta   rnd1
         lda   rnd2
         eor   #$80
         sta   rnd2

+
         txa
         and   #$1f

         ;target page 1

         ora   #$20
         sta   $27
         eor   #$60
         sta   $3d

         ;copy pixel from other page to this page

         lda   ($26), y
         eor   ($3c), y              ; merge source and destination bits
         and   @copymasks, x         ; isolate the bits to replace, zero the rest
         eor   ($26), y              ; unmerge source and destination bits, leaves "to keep" destination bits intact
         sta   ($26), y              ; write the result

         ;exit condition 1

         ldx   rnd2
         bne   @loop

         ;wait while checking for keypress

         lda   $c000
         bmi   @exit

         ;exit condition 2

         lda   rnd1
         cmp   #1
         bne   @loop2

@exit    rts

!align 255,0
@copymasks
         !byte 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
         !byte 2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2
         !byte 4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4
         !byte 8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8
         !byte 16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16
         !byte 32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32
         !byte 64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64
         !byte 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128
